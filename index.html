<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>GM Admin Â· Live Choices</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:Tajawal,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0b0b0b;color:#fff;margin:0;padding:24px}
    .wrap{max-width:820px;margin:auto}
    h1{margin:0 0 8px}
    .hint{opacity:.8;margin:0 0 16px}
    label{display:block;margin:14px 0 6px;font-weight:700}
    input,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid #333;background:#121212;color:#fff}
    button{margin-top:16px;padding:12px 16px;border-radius:10px;border:1px solid #444;background:#1a1a1a;color:#fff;cursor:pointer}
    .row{display:grid;gap:12px}
    .box{border:1px solid #222;padding:16px;border-radius:12px;background:#0f0f0f;margin:16px 0}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .ok{color:#8dff9d}.bad{color:#ff8e8e}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (GM)</h1>
    <div class="hint">Ø­Ø±Ù‘Ø± Ø§Ù„Ù†ØµÙˆØµ Ø«Ù… Ø§Ø¶ØºØ· <b>Ø­ÙØ¸</b> Ù„ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« <span class="mono">choices.json</span> Ù…Ø¨Ø§Ø´Ø±Ø©.</div>

    <div class="box">
      <label>ğŸ”‘ GitHub Token (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)</label>
      <input id="token" type="password" placeholder="ghp_xxxxxxxxx..." />
      <div class="hint">ÙŠÙØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ù…ØªØµÙØ­Ùƒ ÙÙ‚Ø·. Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª: <span class="mono">contents:write</span> Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹.</div>

      <label>ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø«Ø§Ø¨Øª)</label>
      <input id="user" value="beamingkhaled" />

      <label>ğŸ“¦ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Ø«Ø§Ø¨Øª)</label>
      <input id="repo" value="beamingkhaled.github.io" />

      <label>ğŸŒ¿ Ø§Ù„ÙØ±Ø¹</label>
      <input id="branch" value="main" />

      <label>ğŸ“„ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù„Ù</label>
      <input id="path" value="choices.json" />
    </div>

    <div class="box">
      <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø´Ù‡Ø¯</label>
      <input id="title" value="Ø§Ù„Ù…ÙˆÙ„ â€“ Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ø£ÙˆÙ„" />

      <label>Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙŠØ³Ø±</label>
      <input id="left" value="Ù†Ø¯Ø®Ù„ Ø§Ù„Ù‚Ù‡ÙˆØ©ØŸ" />

      <label>Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙŠÙ…Ù†</label>
      <input id="right" value="Ù†ØªÙ…Ø´Ù‰ Ø£ÙˆÙ„ØŸ" />

      <button id="saveBtn">ğŸ’¾ Ø­ÙØ¸ Ø¥Ù„Ù‰ choices.json</button>
      <div id="status" style="margin-top:10px"></div>
    </div>

    <div class="box">
      <label>Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù„Ù„ØªØ£ÙƒÙŠØ¯)</label>
      <pre id="current" class="mono" style="white-space:pre-wrap"></pre>
    </div>
  </div>

  <script>
    // --- helpers ---
    const el = id => document.getElementById(id);
    const setStatus = (msg, ok=false) => el('status').innerHTML = ok ? '<span class="ok">'+msg+'</span>' : '<span class="bad">'+msg+'</span>';
    const b64 = s => btoa(unescape(encodeURIComponent(s)));

    // Persist token locally
    el('token').value = localStorage.getItem('gm_token') || '';
    el('token').addEventListener('change', () => localStorage.setItem('gm_token', el('token').value));

    async function loadCurrent(){
      try{
        const user = el('user').value.trim();
        const repo = el('repo').value.trim();
        const path = el('path').value.trim();
        // Use raw GH to fetch current JSON if exists
        const rawUrl = `https://raw.githubusercontent.com/${user}/${repo}/main/${path}`;
        const res = await fetch(rawUrl, {cache:'no-store'});
        if(res.ok){
          const txt = await res.text();
          el('current').textContent = txt;
          try{
            const data = JSON.parse(txt);
            if(data.title) el('title').value = data.title;
            if(data.left)  el('left').value  = data.left;
            if(data.right) el('right').value = data.right;
          }catch(_){}
        }else{
          el('current').textContent = '(Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ø¨Ø¹Ø¯ â€” Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø­ÙØ¸)';
        }
      }catch(e){
        el('current').textContent = 'Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + e.message;
      }
    }

    async function save(){
      const token  = el('token').value.trim();
      if(!token){ setStatus('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù€ Token Ø«Ù… Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'); return; }

      const user   = el('user').value.trim();
      const repo   = el('repo').value.trim();
      const branch = el('branch').value.trim();
      const path   = el('path').value.trim();

      const payload = {
        title: el('title').value.trim(),
        left:  el('left').value.trim(),
        right: el('right').value.trim(),
        updatedAt: new Date().toISOString()
      };
      const content = b64(JSON.stringify(payload, null, 2));

      setStatus('Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸â€¦');

      // 1) Get current file SHA (if exists)
      let sha = null;
      const getUrl = `https://api.github.com/repos/${user}/${repo}/contents/${encodeURIComponent(path)}?ref=${branch}`;
      const headers = { 'Authorization': 'Bearer ' + token, 'Accept':'application/vnd.github+json' };
      const getRes = await fetch(getUrl, {headers});
      if(getRes.status === 200){
        const j = await getRes.json();
        sha = j.sha;
      } else if (getRes.status !== 404){
        setStatus('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: HTTP '+getRes.status); return;
      }

      // 2) PUT new content
      const putRes = await fetch(getUrl, {
        method: 'PUT',
        headers,
        body: JSON.stringify({
          message: 'chore: update choices.json ('+new Date().toISOString()+')',
          content,
          sha,
          branch
        })
      });

      if(!putRes.ok){
        const t = await putRes.text();
        setStatus('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: HTTP '+putRes.status+' â€” '+t);
        return;
      }

      setStatus('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ… â€” ØªÙ… ØªØ­Ø¯ÙŠØ« choices.json', true);
      el('current').textContent = JSON.stringify(payload, null, 2);
    }

    el('saveBtn').addEventListener('click', save);
    loadCurrent();
  </script>
</body>
</html>
